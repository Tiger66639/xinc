<?xml version="1.0"?>
<project name="Build PEAR - Xinc" basedir="." default="build">

    <target name="build" depends="prepare,copy-data,package-xml,tar" />

    <target name="prepare">
        <property name="build.base.dir" value="../" />
        <property name="pkgname" value="xinc-${version}" />
    </target>

    <target name="pear.package.addtaskref">
        <adhoc-task name="pearpkg2advanced">
        <![CDATA[
        class PearPackage2AdvancedTask extends PearPackage2Task {

            function createMapping() {
                $e = new PearPackageMapping();
                $this->mappings[] = $e;
                return $e;
            }

            function createMapping2() {
                $e = new PearPackageMapping();
                $this->mappings[] = $e;
                return $e;
            }

            protected function setVersion2Options() {
                $arOptions = array();
                foreach ($this->options as $option) {
                    if ('baseinstalldir' === $option->getName()) {
                        $arOptions['baseinstalldir'] = $option->getValue();
                    }
                    if ('packagedirectory' === $option->getName()) {
                        $arOptions['packagedirectory'] = $option->getValue();
                    }
                }
                $this->pkg->setOptions($arOptions);
                parent::setVersion2Options();
            }
        }
        ]]>
        </adhoc-task>
        <adhoc-type name="mapping">
        <![CDATA[
        class PearPackageMapping extends DataType {
            private $name;
            private $elements = array();

            function setName($name) {
                $this->name = $name;
            }

            function getName() {
               return $this->name;
            }

            function createElement() {
                $e = new PearPkgMappingElement();
                $this->elements[] = $e;
                return $e;
            }

            function getElements() {
                if ($this->isReference()) {
                    return $this->getCheckedRef(get_class($this), 'JO')
                        ->getElements();
                } else {
                    return $this->elements;
                }
            }

            public function getValue() {
                $value = array();
                foreach($this->getElements() as $k => $el) {
                    if ($el->getKey() !== null) {
                        $value[ $el->getKey() ] = $el->getValue();
                    } else {
                        $value[] = $el->getValue();
                    }
                }
                return $value;
            }
        }

        ]]>
        </adhoc-type>
    </target>

    <target name="package-xml" depends="pear.package.addtaskref, pear.package.options">
        <echo message="build package.xml..." />
        <pearpkg2advanced name="${pkg.name}" dir="${build.dir.temp} /">
            <option name="outputdirectory" value="./temp/" />
            <option name="packagefile" value="package2.xml" />
            <option name="packagedirectory" value="./temp/${xincversion}/" />
            <option name="baseinstalldir" value="/" />

            <option name="apistability" value="${pkg.stability}" />
            <option name="apiversion" value="${pkg.version}" />
            <option name="channel" value="${pkg.channel}" />
            <option name="description" value="${pkg.description}" />
            <option name="license" value="${pkg.license}" />
            <option name="notes" value="${pkg.relnotes}" />
            <option name="releasestability" value="${pkg.stability}" />
            <option name="releaseversion" value="${pkg.version}" />
            <option name="summary" value="${pkg.summary}" />

            <option name="phpdep" value="5.2.7" />
            <option name="pearinstallerdep" value="1.9.4" />
            <option name="packagetype" value="php" />

            <mapping name="maintainers" refid="maintainers" />
            <mapping name="extdeps" refid="extdeps" />
            <mapping name="deps" refid="deps" />
            <mapping name="replacements" refid="replacements" />

            <fileset dir="${build.dir.temp}/${xincversion}">
                <include name="**/**" />
            </fileset>
        </pearpkg2advanced>
    </target>

    <target name="copy-data">
        <echo message="copy data..." />
    </target>

    <target name="tar">
        <echo message="packaging..." />

        <tar destFile="${build.dir.packages}/${xincversion}.tgz" basedir="${build.dir.temp}/" compression="gzip" />

        <echo message="cleantemp..." />
        <delete dir="${build.dir.temp}" quiet="true" />
        <mkdir dir="${build.dir.temp}" />
    </target>
</project>
